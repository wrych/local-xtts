<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>XTTS Â· Local TTS</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header"
            style="flex-direction: column; align-items: flex-start; gap: 0.5rem; padding-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem;">
                <span class="logo">XT</span>
                <span style="font-size: 1.1rem;">Local XTTS</span>
            </div>
            <strong
                style="font-size: 0.85rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">History</strong>
        </div>
        <a href="{{ url_for('index') }}" class="new-conv-btn">+ New Conversion</a>
        <button type="button" class="settings-btn" onclick="openSettings()">âš™ Settings</button>

        <ul class="conversion-list">
            {% for conv in conversions %}
            <li class="conversion-item">
                <a href="{{ url_for('conversion', conversion_id=conv.id) }}" id="conv-{{ conv.id }}"
                    class="conversion-link {% if conversion and conversion.id == conv.id %}active{% endif %} conv-item-{{ conv.status }}">
                    <span class="conv-title">{{ conv.title }}</span>
                    <div class="conv-meta">
                        <span class="conv-status-text">
                            {% if conv.status != 'done' %}
                            <span class="status-indicator legend-dot {{ conv.status }}"></span>{{ conv.status }}
                            {% endif %}
                        </span>
                        <span>{{ conv.created_at[:10] }}</span>
                    </div>

                    {% if conv.status != 'done' %}
                    <div class="sidebar-progress-bar">
                        <div class="sidebar-progress-inner"
                            style="width: {{ (conv.processed_chunks / conv.total_chunks * 100) if conv.total_chunks > 0 else 0 }}%;">
                        </div>
                    </div>
                    {% endif %}
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content {% if mode == 'view' %}reading-mode-container{% endif %}">
        <div class="card {% if mode == 'view' %}reading-card{% endif %}">
            <form method="post">
                {% if mode == 'view' %}
                <!-- VIEW / PLAYBACK MODE -->
                <div style="margin-bottom: 0.2rem;">
                    <h2 id="reading-title" style="margin:0; font-size: 1.25rem; color: #64748b; cursor: pointer;"
                        onclick="enableTitleEdit(event, '{{job_id}}')" title="Click to rename">{{ title }}</h2>
                    <div class="small-hint"
                        style="margin-bottom: 0.2rem; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <span><span style="color: #94a3b8;">Status:</span> <span id="meta-status-text">{{
                                conversion.status }}</span></span>
                        | <span><span style="color: #94a3b8;">Progress:</span> <span id="meta-progress-text">{{
                                conversion.processed_chunks or 0 }} / {{
                                conversion.total_chunks }}</span></span>
                        {% if conversion.speaker %}
                        | <span style="color: #94a3b8;">Voice:</span> {{ conversion.speaker }}
                        {% endif %}
                        {% if conversion.language %}
                        | <span style="color: #94a3b8;">Lang:</span> {{ conversion.language }}
                        {% endif %}
                        | <span style="color: #94a3b8;">Provider:</span> <span id="meta-provider-text">{{ provider
                            }}</span>

                        <a id="meta-download-link" href="#" download
                            style="display:none; margin-left: auto; color: #2869b8; text-decoration: none; font-weight: 500;">
                            â¬‡ Download .wav
                        </a>
                        <a href="#" onclick="deleteConversion(event, '{{job_id}}')"
                            style="color: #8f1a1a; text-decoration: none; font-weight: 500; font-size: 0.85rem;">
                            Ã— Delete
                        </a>
                    </div>
                </div>

                <div class="modern-player">

                    <div class="player-controls-row">
                        <div class="row-left">
                            <div class="toggle-wrap">
                                <label class="switch">
                                    <input type="checkbox" id="auto-scroll" checked>
                                    <span class="slider-round"></span>
                                </label>
                                <span class="toggle-label">Auto-scroll</span>
                            </div>
                        </div>

                        <div class="row-center">
                            <div class="player-main-controls">
                                <button id="btn-prev" type="button" class="player-nav-btn" title="Previous Sentence"
                                    disabled>
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                                        <path d="M6 6h2v12H6zm3.5 6 8.5 6V6z" />
                                    </svg>
                                </button>
                                <button id="btn-play-pause" type="button" class="player-play-btn" disabled>
                                    <svg id="svg-play" viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                                        <path d="M8 5v14l11-7z" />
                                    </svg>
                                    <svg id="svg-pause" viewBox="0 0 24 24" width="32" height="32" fill="currentColor"
                                        style="display:none;">
                                        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                                    </svg>
                                </button>
                                <button id="btn-next" type="button" class="player-nav-btn" title="Next Sentence"
                                    disabled>
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                                        <path d="m6 18 8.5-6L6 6v12zM16 6v12h2V6h-2z" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="row-right">
                            <div class="speed-control">
                                <span class="speed-limit">0.5x</span>
                                <input type="range" id="playback-speed" min="0.5" max="3.0" step="0.1" value="1.0">
                                <span class="speed-limit">3.0x</span>
                                <div class="speed-badge"><span id="speed-val">1.0</span>x</div>
                            </div>
                        </div>
                    </div>
                    <div class="player-progress-area">
                        <div id="seek-preview-area" class="seek-preview-area"></div>
                        <div class="progress-container-relative">
                            <div id="segments-container" class="segments-container"></div>
                            <input type="range" id="global-seek-bar" min="0" max="100" value="0" step="0.1">
                        </div>
                        <div class="player-time-row">
                            <span>
                                <span id="player-time-current" title="Current time">0s</span> / <span
                                    id="player-time-total" title="Total content duration">0s</span>
                            </span>
                            <span id="player-time-remaining" style="color: #94a3b8; font-weight: 400;"></span>
                        </div>
                    </div>
                </div>

                <div id="sentences-container" class="output-text-box"></div>
                {% else %}
                <!-- NEW CONVERSION MODE -->
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" name="title" value="{{ title or '' }}" required>
                </div>

                <div class="form-group">
                    <label for="text">Text to convert</label>
                    <textarea name="text" id="text" required
                        placeholder="Paste your text here...">{{ text or "" }}</textarea>
                    <div class="small-hint">
                        Long texts are split into sentences and processed with progress tracking.
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <label for="provider">Provider</label>
                        <select id="provider" name="provider" onchange="onProviderChange()">
                            {% for prov in providers %}
                            <option value="{{ prov.id }}" {% if prov.id==provider %}selected{% endif %}>{{ prov.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="small-hint">Select the TTS engine to use.</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <div class="label-row">
                            <label for="language">Language</label>
                        </div>
                        <div class="row">
                            <div class="col">
                                <select id="language" name="language" onchange="onLanguageChange()">
                                    {% for lang in languages %}
                                    <option value="{{ lang }}" {% if lang==language %}selected{% endif %}>{{ lang }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="small-hint">Controls pronunciation & prosody.</div>
                            </div>
                            <div class="min-col">
                                <button type="button" class="save-default-btn" onclick="saveAsDefault('language')"
                                    title="Save as default language for this provider">
                                    ðŸ’¾
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col">
                        <div class="label-row">
                            <label for="speaker">Voice</label>
                        </div>
                        <div class="row">
                            <div class="col">
                                <select id="speaker" name="speaker">
                                    {% for spk in speakers %}
                                    <option value="{{ spk }}" {% if spk==speaker %}selected{% endif %}>{{ spk }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="small-hint" id="speaker-hint">Choose one of the voices available for the
                                    selected
                                    language.</div>
                            </div>
                            <div class="min-col">
                                <button type="button" class="save-default-btn" onclick="saveAsDefault('voice')"
                                    title="Save as default voice for this provider">
                                    ðŸ’¾
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="checkbox-row" style="margin-bottom: 1.5rem;">
                    <input type="checkbox" id="use_cuda" name="use_cuda" {% if use_cuda %}checked{% endif %}>
                    <label for="use_cuda" style="margin:0;">Use CUDA / GPU</label>
                </div>

                <button type="submit">Start Conversion</button>

                {% endif %}
            </form>



            <div id="result" class="result" style="display:none;"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSettings()">&times;</span>
            <h2 style="margin-top: 0;">Settings</h2>

            <div class="settings-tabs"
                style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #334155;">
                <button type="button" class="tab-btn active" onclick="switchSettingsTab('general')">General</button>
                <button type="button" class="tab-btn" onclick="switchSettingsTab('providers')">Providers</button>
            </div>

            <div id="general-settings-panel">
                <div class="form-group">
                    <label for="settings-playback-speed">Default Playback Speed</label>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="range" id="settings-playback-speed" min="0.5" max="3.0" step="0.1" value="1.0"
                            oninput="document.getElementById('settings-speed-val').textContent = parseFloat(this.value).toFixed(1)">
                        <span style="min-width: 40px;"><span id="settings-speed-val">1.0</span>x</span>
                    </div>
                    <div class="small-hint">Global playback speed for all conversions.</div>
                </div>
            </div>

            <div id="provider-settings-panel" style="display: none;">
                <div class="form-group">
                    <label for="settings-provider-select">Select Provider to Configure</label>
                    <select id="settings-provider-select" onchange="loadProviderSettings()">
                        {% for prov in providers %}
                        <option value="{{ prov.id }}">{{ prov.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="settings-fields">
                    <!-- Dynamic fields based on provider -->
                </div>
                <hr style="border: 0; border-top: 1px solid #334155; margin: 1.5rem 0;">
                <h3 style="font-size: 1rem; margin-bottom: 1rem;">Default Selection</h3>
                <div class="form-group">
                    <label for="settings-default-language">Default Language</label>
                    <select id="settings-default-language"></select>
                </div>
                <div class="form-group">
                    <label for="settings-default-voice">Default Voice</label>
                    <select id="settings-default-voice"></select>
                </div>
            </div>

            <div style="margin-top: 2rem;">
                <button type="button" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        const JOB_ID = "{{ job_id or '' }}";
        // text is only needed in view mode for rendering
        const FULL_TEXT = {{ (text or "") | tojson }};
        const LAST_PLAYED_INDEX = {{ last_played_index if last_played_index is defined else -1 }};
        const MODE = "{{ mode }}";
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>

</html>