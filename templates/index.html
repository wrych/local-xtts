<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>XTTS · Local TTS</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header"
            style="flex-direction: column; align-items: flex-start; gap: 0.5rem; padding-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem;">
                <span class="logo">XT</span>
                <span style="font-size: 1.1rem;">Local XTTS</span>
            </div>
            <strong
                style="font-size: 0.85rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">History</strong>
        </div>
        <a href="{{ url_for('index') }}" class="new-conv-btn">+ New Conversion</a>

        <ul class="conversion-list">
            {% for conv in conversions %}
            <li class="conversion-item">
                <a href="{{ url_for('conversion', conversion_id=conv.id) }}" id="conv-{{ conv.id }}"
                    class="conversion-link {% if conversion and conversion.id == conv.id %}active{% endif %} conv-item-{{ conv.status }}">
                    <span class="conv-title">{{ conv.title }}</span>
                    <div class="conv-meta">
                        <span class="conv-status-text">
                            {% if conv.status != 'done' %}
                            <span class="status-indicator legend-dot {{ conv.status }}"></span>{{ conv.status }}
                            {% endif %}
                        </span>
                        <span>{{ conv.created_at[:10] }}</span>
                    </div>

                    {% if conv.status != 'done' %}
                    <div class="sidebar-progress-bar">
                        <div class="sidebar-progress-inner"
                            style="width: {{ (conv.processed_chunks / conv.total_chunks * 100) if conv.total_chunks > 0 else 0 }}%;">
                        </div>
                    </div>
                    {% endif %}
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content {% if mode == 'view' %}reading-mode-container{% endif %}">
        <div class="card {% if mode == 'view' %}reading-card{% endif %}">
            <form method="post">
                {% if mode == 'view' %}
                <!-- VIEW / PLAYBACK MODE -->
                <div style="margin-bottom: 0.2rem;">
                    <h2 id="reading-title" style="margin:0; font-size: 1.25rem; color: #64748b; cursor: pointer;"
                        onclick="enableTitleEdit(event, '{{job_id}}')" title="Click to rename">{{ title }}</h2>
                    <div class="small-hint"
                        style="margin-bottom: 0.2rem; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <span><span style="color: #94a3b8;">Status:</span> <span id="meta-status-text">{{
                                conversion.status }}</span></span>
                        | <span><span style="color: #94a3b8;">Progress:</span> <span id="meta-progress-text">{{
                                conversion.processed_chunks or 0 }} / {{
                                conversion.total_chunks }}</span></span>
                        {% if conversion.speaker %}
                        | <span style="color: #94a3b8;">Voice:</span> {{ conversion.speaker }}
                        {% endif %}
                        {% if conversion.language %}
                        | <span style="color: #94a3b8;">Lang:</span> {{ conversion.language }}
                        {% endif %}

                        <a id="meta-download-link" href="#" download
                            style="display:none; margin-left: auto; color: #2869b8; text-decoration: none; font-weight: 500;">
                            ⬇ Download .wav
                        </a>
                        <a href="#" onclick="deleteConversion(event, '{{job_id}}')"
                            style="color: #8f1a1a; text-decoration: none; font-weight: 500; font-size: 0.85rem;">
                            × Delete
                        </a>
                    </div>
                </div>

                <div class="player-controls-bar" style="margin-bottom: 0.25rem; display: flex; align-items: center;">
                    <button id="btn-play-pause" type="button" class="ctrl-btn" disabled>Play</button>

                    <label for="playback-speed" style="margin-left: 1.5rem; margin-right: 0.5rem;">
                        Speed (<span id="speed-val">1.0</span>)
                    </label>
                    <input type="range" id="playback-speed" min="0.5" max="3.0" step="0.1" value="1.0"
                        list="speed-markers" style="width: 120px;">
                    <datalist id="speed-markers">
                        <option value="1.0"></option>
                    </datalist>
                </div>

                <div id="sentences-container" class="output-text-box"></div>
                {% else %}
                <!-- NEW CONVERSION MODE -->
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" name="title" value="{{ title or '' }}" required>
                </div>

                <div class="form-group">
                    <label for="text">Text to convert</label>
                    <textarea name="text" id="text" required
                        placeholder="Paste your text here...">{{ text or "" }}</textarea>
                    <div class="small-hint">
                        Long texts are split into sentences and processed with progress tracking.
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <label for="speaker">Voice</label>
                        <select id="speaker" name="speaker">
                            {% for spk in speakers %}
                            <option value="{{ spk }}" {% if spk==speaker %}selected{% endif %}>{{ spk }}</option>
                            {% endfor %}
                        </select>
                        <div class="small-hint">Choose one of the pre-defined XTTS speakers.</div>
                    </div>

                    <div class="col">
                        <label for="language">Language</label>
                        <select id="language" name="language">
                            {% for lang in languages %}
                            <option value="{{ lang }}" {% if lang==language %}selected{% endif %}>{{ lang }}</option>
                            {% endfor %}
                        </select>
                        <div class="small-hint">Controls pronunciation & prosody for the generated audio.</div>
                    </div>
                </div>

                <div class="checkbox-row" style="margin-bottom: 1.5rem;">
                    <input type="checkbox" id="use_cuda" name="use_cuda" {% if use_cuda %}checked{% endif %}>
                    <label for="use_cuda" style="margin:0;">Use CUDA / GPU</label>
                </div>

                <button type="submit">Start Conversion</button>

                {% endif %}
            </form>



            <div id="result" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        const JOB_ID = "{{ job_id or '' }}";
        // text is only needed in view mode for rendering
        const FULL_TEXT = {{ (text or "") | tojson }};
        const LAST_PLAYED_INDEX = {{ last_played_index if last_played_index is defined else -1 }};
        const MODE = "{{ mode }}";
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>

</html>